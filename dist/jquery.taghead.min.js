/*
 *  jQuery TagHead - v0.5.1
 *  A magical mix between an input tag system, and a typahead engine.
 *  
 *
 *  Made by Caligone
 *  Under MIT License
 */
(function(){!function(a){var b,c,d;return d="taghead",c={remote:{enable:!1,source:"",method:"GET",sentParam:"value",displayData:"value",storeData:"value",minLength:2,forceValid:!1,limit:-1},allowDuplicates:!1,style:{wrapperClass:"",tagClass:"",tagListWrapperClass:"",tagListClass:"",tagListItemClass:"",inputClass:""},text:{phAddTag:"Add a tag"}},b=function(){function b(b,e){this.element=b,this.settings=a.extend(!0,this.settings,c,e),this._defaults=c,this._name=d,this.tags=[],this.ids=[],this.element=a(this.element),this._init()}return b.prototype._init=function(){var b,c,d,e,f,g,h,i;if(this.element.addClass("th-original-input"),this.element.wrap("<span class='th-wrapper "+this.settings.style.wrapperClass+"'></span>"),this.wrapper=this.element.parent(),this.wrapper.append("<input type='text' class='th-input "+this.settings.style.inputClass+"' placeholder='"+this.settings.text.phAddTag+"' autocomplete='off' spellcheck='false' dir='auto'/>"),this.input=this.wrapper.find(".th-input"),this.wrapper.append("<div class='th-tag-list-wrapper "+this.settings.style.tagListWrapperClass+"'><span class='th-tag-list "+this.settings.style.tagListClass+"'></span></div>"),this.list=this.wrapper.find(".th-tag-list"),this.list.hide(),this.element.hide(),""!==this.element.val())if(this.element.data("tags")&&""!==this.element.data("tags"))for(d=this.element.data("tags").split(","),c=this.element.val().split(","),b=f=0,h=d.length;h>f;b=++f)e=d[b],this.addTag(e,c[b]);else for(d=this.element.val().split(","),g=0,i=d.length;i>g;g++)e=d[g],this.addTag(e,e);return this.input.on("keyup",function(b){return function(c){var d;if(13===c.keyCode){if(b.wrapper.find(".th-active").length>0)b.addTag(b.wrapper.find(".th-active").text(),b.wrapper.find(".th-active").data("id"));else{if(b.settings.remote.forceValid)return;b.addTag(b.input.val(),b.input.val())}b.input.val(""),b.list.empty(),b.list.hide()}return 38===c.keyCode?void b._keyboard(!0):40===c.keyCode?void b._keyboard(!1):b.input.val().length<b.settings.remote.minLength||27===c.keyCode?(b.list.empty(),void b.list.hide()):b.settings.remote.enable?(d={},d[b.settings.remote.sentParam]=b.input.val(),a.ajax({type:b.settings.remote.method,url:b.settings.remote.source,data:d}).done(function(a){var c,d,e;for(b.list.empty(),d=0,e=a.length;e>d;d++)c=a[d],b.list.append("<a data-id='"+c[b.settings.remote.storeData]+"' class='th-tag-list-item "+b.settings.style.tagListItemClass+"'>"+c[b.settings.remote.displayData]+"</a>");return b.list.show(),b.element.trigger("th.remoteresponse")})):void 0}}(this)),this.input.on("keydown",function(a){return function(b){return 8===b.keyCode&&0===a.input.val().length?a.removeTag(a.tags[a.tags.length-1]):void 0}}(this)),this.wrapper.on("click","a.th-tag-link",function(b){return function(c){var d;return d=a(c.target).text(),b.removeTag(d),c.preventDefault()}}(this)),this.wrapper.on("click","a.th-tag-list-item",function(b){return function(c){return b.addTag(a(c.target).text(),a(c.target).attr("data-id")),b.list.empty(),b.list.hide(),b.input.val(""),b.element.trigger("th.clicktoadd"),c.preventDefault()}}(this)),this.wrapper.on("mouseenter","a.th-tag-list-item",function(){return a(this).addClass("th-active")}),this.wrapper.on("mouseleave","a.th-tag-list-item",function(){return a(this).removeClass("th-active")})},b.prototype.addTag=function(a,b){return!this.settings.allowDuplicates&&(this.tags.indexOf(a)>-1||this.ids.indexOf(b)>-1)||-1!==this.settings.limit&&this.tags.length>=this.settings.limit?void 0:(this.input.before("<span class='th-tag "+this.settings.style.tagClass+"' data-label='"+a+"' data-id="+b+"><a href='#' class='th-tag-link'>"+a+"</a></span>"),this.tags.push(a),this.ids.push(b),this.element.val(this.ids.join(",")),this.element.trigger("th.addtag"))},b.prototype.removeTag=function(a,b){var c,d;return c=null!=b?this.ids.indexOf(b):this.tags.indexOf(a),c>-1&&(this.tags.splice(c,1),this.ids.splice(c,1),d=this.wrapper.find(".th-tag[data-label='"+a+"']"),d.hasClass(this.settings.style.tagClass))?(d.remove(),this.element.val(this.ids.join(",")),this.element.trigger("th.removetag")):void 0},b.prototype.clearTag=function(){var a;for(a=[];this.tags.length>0;)a.push(this.removeTag(this.tags[0],this.ids[0]));return a},b.prototype._keyboard=function(a){var b;if(!(this.input.val().length<this.settings.remote.minLength))return this.wrapper.find(".th-active").length>0?(b=this.wrapper.find(".th-active"),a?this.wrapper.find(".th-active").prev().addClass("th-active"):this.wrapper.find(".th-active").next().addClass("th-active"),b.removeClass("th-active")):a?this.wrapper.find(".th-tag-list-item").last().addClass("th-active"):this.wrapper.find(".th-tag-list-item").first().addClass("th-active")},b}(),a.fn[d]=function(e){return this.each(function(){var f;return a.data(this,"plugin_"+d)?void 0:(f=a.extend(!0,c,e),a.data(this,"plugin_"+d,new b(this,f)))}).data("plugin_"+d)}}(jQuery,window,document)}).call(this);